<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HWDE Fairy Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020817;
      --panel: #0b1120;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.13);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #fb7185;
      --radius: 14px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, -sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 10px;
      font-family: var(--font);
      background:
        radial-gradient(circle at top, #111827 0, #020817 55%, #000 100%);
      color: var(--text);
    }
    .app {
      max-width: 900px;
      margin: 0 auto 24px;
      padding: 10px;
      border-radius: 18px;
      background: rgba(6,8,18,0.98);
      border: 1px solid rgba(148,163,253,0.16);
      box-shadow: 0 16px 40px rgba(0,0,0,0.6);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.35rem;
      text-align: center;
    }
    p { margin: 4px 0; font-size: 0.8rem; color: var(--muted); }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .lang-toggle {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,253,0.4);
      background: #020817;
      font-size: 0.7rem;
    }
    .lang-btn {
      border: none;
      padding: 4px 9px;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }
    .lang-btn.active {
      background: var(--accent);
      color: #020817;
      font-weight: 600;
    }

    .section {
      margin-top: 8px;
      padding: 8px;
      border-radius: var(--radius);
      background: var(--panel);
      border: 1px solid rgba(75,85,99,0.6);
    }
    .section h2 {
      margin: 0 0 4px;
      font-size: 0.95rem;
    }
    label {
      display: block;
      margin-bottom: 2px;
      font-size: 0.75rem;
      color: var(--muted);
    }
    select, input[type="number"] {
      width: 100%;
      padding: 5px 7px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,253,0.35);
      background: #020817;
      color: var(--text);
      font-size: 0.75rem;
      outline: none;
    }
    select:focus, input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }
    .grid2 {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 8px;
    }
    @media (max-width: 640px) {
      .grid2 { grid-template-columns: 1fr; }
    }

    .toggle-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      margin: 0 4px 4px 0;
      border-radius: 999px;
      border: 1px solid rgba(148,163,253,0.45);
      font-size: 0.65rem;
      color: var(--muted);
      cursor: pointer;
      background: #020817;
    }
    .toggle-pill span {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: #111827;
    }
    .toggle-pill.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
    }
    .toggle-pill.active span {
      background: var(--accent);
      box-shadow: 0 0 4px var(--accent);
    }

    .trait-row {
      display: grid;
      grid-template-columns: 1.8fr 0.7fr;
      gap: 4px;
      align-items: center;
      margin-bottom: 3px;
    }
    .trait-label {
      font-size: 0.72rem;
      color: var(--text);
    }
    .trait-label small {
      color: var(--muted);
      font-size: 0.6rem;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 4px;
    }
    .chip {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,253,0.35);
      font-size: 0.65rem;
      color: var(--muted);
      cursor: pointer;
      background: #020817;
    }
    .chip.active {
      background: var(--accent);
      color: #020817;
      border-color: var(--accent);
      font-weight: 600;
    }

    #generateBtn {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(90deg, var(--accent), #22c55e);
      color: #020817;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.7);
    }
    #generateBtn:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.8);
    }

    .plan {
      margin-top: 6px;
      font-size: 0.75rem;
      line-height: 1.5;
    }
    .step {
      margin-top: 5px;
      padding: 6px;
      border-radius: 12px;
      background: #020817;
      border: 1px solid rgba(148,163,253,0.25);
    }
    .step-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
    }
    .step-sub {
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .food-list {
      margin: 2px 0 2px 12px;
      padding: 0;
      list-style: disc;
    }
    .food-list li {
      margin: 0;
    }
    .warn {
      font-size: 0.7rem;
      color: var(--danger);
    }
    details summary {
      cursor: pointer;
      font-size: 0.7rem;
      color: var(--accent);
      margin-top: 3px;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div>
      <h1 id="title">HWDE Fairy Planner</h1>
      <p id="subtitle">
        Plan a full ‚Äúrainbow‚Äù fairy: the 10 key skills that unlock every other skill.
      </p>
    </div>
    <div class="lang-toggle">
      <button class="lang-btn active" data-lang="en">English</button>
      <button class="lang-btn" data-lang="fr">Fran√ßais</button>
    </div>
  </div>

  <!-- 1. Setup -->
  <div class="section">
    <h2 data-i18n="setupTitle">1. Fairy setup</h2>
    <div class="grid2">
      <div>
        <label data-i18n="elementLabel">Element</label>
        <select id="fairyElement">
          <option value="fire">Fire</option>
          <option value="water">Water</option>
          <option value="lightning">Lightning</option>
          <option value="light">Light</option>
          <option value="dark">Darkness</option>
        </select>
        <label data-i18n="startLevelLabel" style="margin-top:4px;">Current level</label>
        <input id="startLevel" type="number" min="1" max="99" value="1" />
        <label data-i18n="maxLevelLabel" style="margin-top:4px;">Level cap before Refresh</label>
        <input id="maxLevel" type="number" min="10" max="99" value="99" />
        <div class="chips">
          <div class="chip active" id="optGold" data-on="true">
            ‚ú® Allow gold food
          </div>
          <div class="chip active" id="optCheap" data-on="true">
            üí∞ Prefer bronze/silver
          </div>
        </div>
      </div>
      <div>
        <label data-i18n="activeTraitsLabel">Active personalities (tap, max 5)</label>
        <div id="activeTraits"></div>
        <p data-i18n="activeTraitsHint">
          Choose the 5 traits your fairy currently shows in white. This helps the route suggest smart swaps.
        </p>
      </div>
    </div>
  </div>

  <!-- 2. Traits -->
  <div class="section">
    <h2 data-i18n="traitsTitle">2. Current personality values</h2>
    <p data-i18n="traitsHint">
      Enter approximate values from the My Fairy screen. Leave 0 if unsure; the planner shows how much each step needs.
    </p>
    <div id="traitsGrid"></div>
  </div>

  <!-- 3. Inventory (optional) -->
  <div class="section">
    <h2 data-i18n="inventoryTitle">3. Food limits (optional)</h2>
    <p data-i18n="inventoryHint">
      Only if you care: set max uses for some foods. Leave blank for no limit.
    </p>
    <details>
      <summary data-i18n="showInventory">Show editable limits for key foods</summary>
      <div id="inventoryGrid"></div>
    </details>
  </div>

  <!-- 4. Route -->
  <div class="section">
    <h2 data-i18n="routeTitle">4. Target 10-skill route</h2>
    <p data-i18n="routeDesc">
      Fixed chain: Extreme Crush+ ‚Üí Glass Cannon ‚Üí XP Master+ ‚Üí Total Focus ‚Üí Weapon Master+ ‚Üí
      Magic Fountain+ ‚Üí Food Master+ ‚Üí Special Fountain+ ‚Üí Wall of Water+ ‚Üí Material Master+.
      After each: Refresh + 1 personality swap.
    </p>
    <ul id="routeList" style="font-size:0.7rem; padding-left:16px; color:var(--muted);"></ul>
  </div>

  <button id="generateBtn">Generate step-by-step plan</button>

  <!-- 5. Plan -->
  <div class="section">
    <h2 data-i18n="planTitle">5. Plan</h2>
    <div id="plan" class="plan">
      <p data-i18n="planEmpty">
        Fill everything above, then tap Generate. You‚Äôll get one card per Refresh cycle with concrete foods & swaps.
      </p>
    </div>
    <details>
      <summary data-i18n="explainSummary">How this planner thinks</summary>
      <p data-i18n="explainText">
        For each step: we take your current traits and level, use the GameFAQs Dining Room values
        (bronze/silver/gold, element bonus) to choose efficient foods that reach the exact thresholds for the next key skill
        before your level cap. Then we suggest which personality to swap on Refresh following a known ‚Äúrainbow‚Äù route.
        Trait carry-over is approximated; if you‚Äôre slightly off in-game, you can adjust by a few extra feeds.
      </p>
    </details>
  </div>

  <p style="font-size:0.6rem; color:var(--muted); margin-top:6px;">
    Based on in-game data & community research (GameFAQs ‚ÄúMy Fairy Unlockables‚Äù Dining Room table).
    Gratitude Crystals intentionally excluded.
  </p>
</div>

<script>
/* ========== TRAITS ========== */
const TRAITS = [
  { code: 'SPK', en: 'Sparkly',  fr: '√âtincelante' },
  { code: 'RLX', en: 'Relaxed',  fr: 'D√©tendue' },     // Soft
  { code: 'VAL', en: 'Valiant',  fr: 'Frimeuse' },     // Flashy
  { code: 'DIZ', en: 'Dizzy',    fr: '√âtourdie' },
  { code: 'FRN', en: 'Friendly', fr: 'Amicale' },
  { code: 'ASP', en: 'Aspiring', fr: 'R√™veuse' },      // Dreamy
  { code: 'RES', en: 'Resolute', fr: 'D√©termin√©e' },
  { code: 'SHR', en: 'Shrewd',   fr: 'Fut√©e' },        // Fleet
  { code: 'EAG', en: 'Eager',    fr: 'Impatiente' },
  { code: 'SMI', en: 'Smiley',   fr: 'Souriante' }
];

function tName(code, lang) {
  const t = TRAITS.find(x => x.code === code);
  if (!t) return code;
  return lang === 'fr' ? t.fr : t.en;
}

/* ========== SKILL REQS (RAINBOW) ========== */
/* Based on My Fairy Unlockables table; focusing on the 10 ‚Äú+‚Äù/core skills. */
const SKILLS = {
  'Extreme Crush+': { RES:200, VAL:225, SPK:225, SMI:225, FRN:255 },
  'Glass Cannon':   { SPK:200, RES:200, FRN:225, DIZ:225 },
  'XP Master+':     { EAG:200, SPK:200, RES:225, DIZ:225 },
  'Total Focus':    { FRN:100, RES:100, EAG:125 },
  'Weapon Master+': { DIZ:200, EAG:225, SHR:225, RLX:225, FRN:255 },
  'Magic Fountain+':{ ASP:200, VAL:225, RLX:225, EAG:225, SHR:255 },
  'Food Master+':   { VAL:200, RLX:225, ASP:225, RES:225, EAG:255 },
  'Special Fountain+':{ ASP:200, RES:225, VAL:225, EAG:225, SPK:255 },
  'Wall of Water+': { ASP:200, VAL:200, SMI:225, SPK:225 },
  'Material Master+':{ SMI:200, VAL:225, RLX:225, ASP:225, RES:255 }
};

/* Route order & personality swaps between refreshes */
const ROUTE = [
  { name: 'Extreme Crush+',    swap: { from: 'SMI', to: 'DIZ' } },
  { name: 'Glass Cannon',      swap: { from: 'VAL', to: 'EAG' } },
  { name: 'XP Master+',        swap: { from: 'SPK', to: 'RLX' } },
  { name: 'Total Focus',       swap: { from: 'RES', to: 'SHR' } },
  { name: 'Weapon Master+',    swap: { from: 'DIZ', to: 'ASP' } },
  { name: 'Magic Fountain+',   swap: { from: 'FRN', to: 'VAL' } },
  { name: 'Food Master+',      swap: { from: 'SHR', to: 'RES' } },
  { name: 'Special Fountain+', swap: { from: 'RLX', to: 'SPK' } },
  { name: 'Wall of Water+',    swap: { from: 'EAG', to: 'SMI' } },
  { name: 'Material Master+',  swap: null }
];

/* ========== FOOD DATA ========== */
/*
  To stay readable:
  - We define foods in a compact format:
    { base, type, element, rows: [ [bronze], [silver], [gold] ] }
  - Each row is [SPK,RLX,VAL,DIZ,FRN,ASP,RES,SHR,EAG,SMI]
  - Values taken from GameFAQs Dining Room table (no Gratitude Crystals).
  - We then expand to FOODS[] with proper rarity, lvCost (1/2/3), names.

  NOTE: This includes all *key* foods used in common rainbow routes.
  You can extend FOOD_BASE with every remaining food row from the guide.
*/
const FOOD_BASE = [
  // ===== FEAST =====
  ['Weird Egg', 'Feast', 'light',
    [ 2,  0,  2,  0, -1,  0,  2,  0,  0,  0],
    [ 5, -2,  2,  0,  0,  0,  5,  0,  2,  0],
    [10, -5,  5, -2,  2,  0,  5, -2,  2,  0]
  ],
  ['All-Purpose Bait', 'Feast', 'light',
    [ 0,  0, -1,  0,  2,  0,  2,  0,  0,  2],
    [ 2,  0,  0,  0,  5,  0,  2,  0, -2,  5],
    [ 2,  0,  2,  0,  5, -2,  5, -2, -5, 10]
  ],
  ['Ordon Goat Cheese', 'Feast', 'light',
    [ 0,  2,  2,  0,  0,  0,  2,  0, -1,  0],
    [ 0,  2,  5, -2,  0,  2,  5,  0,  0,  0],
    [-2,  5, 10, -5,  0,  2,  5, -2,  2,  0]
  ],
  ['Meat', 'Feast', 'fire',
    [ 0, -1,  2,  0,  0,  0,  2,  2,  0,  0],
    [ 0,  0,  5, -2,  2,  0,  5,  2,  0,  0],
    [ 0,  2, 10, -5,  2,  0, -2,  5,  5, -2]
  ],

  // ===== DRINK =====
  ['Lon Lon Milk', 'Drink', 'light',
    [ 2,  0, -1,  0,  0,  0,  5,  0,  2,  0],
    [ 2,  0,  0,  0,  2,  0,  5, -2,  5,  0],
    [ 5, -2,  2,  0,  2,  0, 10, -5,  5, -2]
  ],
  ['Pumpkin Soup', 'Drink', 'fire',
    [ 0,  0,  0, -1,  2,  0,  2,  0,  2,  0],
    [ 2,  0,  0,  0,  2,  0,  5, -2,  5,  0],
    [ 2,  0,  0,  2,  5, -2, 10, -5,  5, -2]
  ],
  ['Sacred Water', 'Drink', 'water',
    [ 2,  0,  0, -1,  2,  0,  2,  0,  0,  0],
    [ 5, -2,  0,  0,  5,  0,  2,  0,  2,  0],
    [10, -5,  0,  2,  5, -2,  5, -2,  2,  0]
  ],
  ['Elixir Soup', 'Drink', 'fire',
    [ 0,  0, -1,  0,  2,  0,  2,  0,  0,  2],
    [ 2,  0,  0,  0,  2,  0,  2,  0, -2,  5],
    [ 2,  0,  2,  0,  5,  2,  5, -2, -5, 10]
  ],
  ['Great Fairy\'s Tears', 'Drink', 'light',
    [ 0,  2,  0,  0,  0,  2,  2,  0, -1,  0],
    [ 0,  5,  2,  0, -2,  5,  2,  0,  0,  0],
    [-2,  5,  2,  0, -5, 10,  5, -2,  2,  0]
  ],
  ['Chateau Romani', 'Drink', 'dark',
    [ 0,  0,  2,  0,  2,  0,  0,  2, -1,  0],
    [ 0,  2,  5, -2,  5,  0,  0,  2,  0,  0],
    [ 0,  2, 10, -5,  5, -2, -2,  5,  2,  0]
  ],
  ['Bottled Water', 'Drink', 'water',
    [ 0,  2, -1,  0,  2,  0,  0,  2,  0,  0],
    [ 0,  5,  0,  0,  5, -2,  0,  2,  2,  0],
    [-2,  5,  2,  0, 10, -5, -2,  5,  2,  0]
  ],
  ['Hot Spring Water', 'Drink', 'water',
    [ 0,  2,  0,  0, -1,  0,  0,  2,  2,  0],
    [ 2,  5,  2,  0,  0,  0,  0,  2,  5,  0],
    [-5,10,  2,  0,  2,  0, -2,  5,  5, -2]
  ],

  // ===== PLANT =====
  ['Odd Mushroom', 'Plant', 'dark',
    [ 0,  0,  2,  0,  2,  0,  2,  0, -1,  0],
    [ 2,  0,  5, -2,  2,  0,  5,  0,  0,  0],
    [ 2,  0, 10, -5,  5, -2,  5, -2,  2,  0]
  ],
  ['Deku Nut', 'Plant', 'light',
    [ 1,  0,  2,  0,  2,  0,  2,  0,  0,  0],
    [ 0,  0,  5,  0,  5, -2,  2,  0,  2,  0],
    [ 2,  0,  5, -2, 10, -5,  5, -2,  2,  0]
  ],
  ['Magic Beans', 'Plant', 'water',
    [ 2,  0, -1,  0,  2,  0,  0,  0,  2,  0],
    [ 5,  0,  0,  0,  5, -2,  2,  0,  2,  0],
    [ 5, -2,  2,  0, 10, -5,  2,  0,  5, -2]
  ],
  ['Life Tree Fruit', 'Plant', 'light',
    [ 0,  0,  0, -1,  2,  0,  2,  0,  2,  0],
    [ 2,  0,  0,  0,  5, -2,  5,  0,  2,  0],
    [ 2,  0,  0,  2, 10, -5,  5, -2,  5, -2]
  ],
  ['Light Fruit', 'Plant', 'light',
    [ 2,  0,  0, -1,  2,  0,  0,  0,  2,  0],
    [ 5, -2,  0,  0,  5,  0,  2,  0,  2,  0],
    [10, -5,  0,  2,  5, -2,  2,  0,  5, -2]
  ],
  ['Stamina Fruit', 'Plant', 'fire',
    [ 2,  0,  0,  0, -1,  0,  2,  0,  2,  0],
    [ 5,  0,  0,  2,  0,  0,  5, -2,  2,  0],
    [ 5, -2,  0,  2,  2,  0,10, -5,  5, -2]
  ],
  ['Water Fruit', 'Plant', 'water',
    [-1, 0,  0,  2,  2,  0,  2,  0,  0,  0],
    [ 0,  0,  0,  5,  2,  0,  5, -2,  2,  0],
    [ 2,  0, -2, 5,  5, -2,10, -5,  2,  0]
  ],
  ['Hyoi Pear', 'Plant', 'wind', // treated as lightning/wind
    [-1, 0,  2,  0,  2,  0,  0,  0,  0,  2],
    [ 0,  0,  5,  0,  2,  0,  2,  0, -2,  5],
    [ 2,  0,  5, -2, 5, -2,  2,  0, -5, 10]
  ],
  ['Carrot', 'Plant', 'lightning',
    [-1, 0,  2,  0,  0,  0,  0,  2,  0,  2],
    [ 0,  0,  2,  0,  2,  0, -2,  5,  0,  5],
    [ 2,  0,  5, -2, 2,  0, -5,10, -2,  5]
  ],
  ['Ember Seeds', 'Plant', 'fire',
    [ 0,  0,  2,  0, -1,  0,  0,  2,  2,  0],
    [ 0,  2,  5, -2,  0,  0,  0,  2,  5,  0],
    [ 0,  2, 10, -5,  2,  0, -2,  5,  5, -2]
  ],
  ['Scent Seeds', 'Plant', 'dark',
    [ 0,  0,  2,  0,  2,  0,  0,  2, -1,  0],
    [ 0,  2,  5,  0,  2,  0, -2,  5,  0,  0],
    [ 0,  2,  5, -2,  5, -2, -5,10,  2,  0]
  ],
  ['Pegasus Seeds', 'Plant', 'lightning',
    [ 0, -1,  0,  0,  2,  0,  0,  2,  2,  0],
    [ 0,  0,  2,  0,  2,  0, -2,  5,  5,  0],
    [ 0,  2,  2,  0,  5, -2, -5,10,  5, -2]
  ],
  ['Gale Seeds', 'Plant', 'wind',
    [ 0,  2,  2,  0,  2,  0,  0,  0, -1,  0],
    [ 0,  2,  5, -2,  5,  0,  0,  2,  0,  0],
    [-2,  5, 10, -5,  5, -2,  0,  2,  2,  0]
  ],
  ['Mystery Seeds', 'Plant', 'light',
    [ 0,  2,  2,  0,  2,  0,  0, -1,  0,  0],
    [ 0,  5,  2,  0,  5, -2,  0,  0,  2,  0],
    [-2,  5,  5, -2,10, -5,  0,  2,  2,  0]
  ],
  ['Pumpkin', 'Plant', 'light',
    [-1, 0,  0,  0,  2,  0,  2,  0,  2,  0],
    [ 0,  0,  0,  2,  2,  0,  2,  0,  5, -2],
    [ 2,  0,  0,  2,  5, -2,  5, -2,10, -5]
  ],

  // ===== FISH =====
  ['Greengill', 'Fish', 'water',
    [ 0,  0, -1,  0,  0,  2,  2,  0,  2,  0],
    [ 0,  2,  0,  0, -2,  5,  2,  0,  5,  0],
    [ 0,  2,  2,  0, -5,10,  5, -2,  5, -2]
  ],
  ['Ordon Catfish', 'Fish', 'water',
    [ 0,  2,  2,  0,  0,  2, -1,  0,  0,  0],
    [-2,  5,  5,  0,  0,  2,  0,  0,  2,  0],
    [-5,10,  5, -2, -2,  5,  2,  0,  2,  0]
  ],
  ['Hyrule Bass', 'Fish', 'water',
    [ 0,  2,  2,  0,  0,  0,  2,  0, -1,  0],
    [-2,  5,  2,  0,  0,  2,  5,  0,  0,  0],
    [-5,10,  5, -2,  0,  2,  5, -2,  2,  0]
  ],
  ['Hylian Pike', 'Fish', 'water',
    [ 0,  2,  0,  0,  0, -1,  2,  0,  2,  0],
    [ 0,  2,  2,  0,  0,  0,  5, -2,  5,  0],
    [-2,  5,  2,  0,  0,  2, 10, -5,  5, -2]
  ],
  ['Reekfish', 'Fish', 'water',
    [ 0,  2,  2,  0,  0, -1,  2,  0,  0,  0],
    [ 0,  2,  5, -2,  0,  0,  5,  0,  2,  0],
    [-2,  5, 10, -5,  0,  2,  5, -2,  2,  0]
  ],
  ['Hylian Loach', 'Fish', 'water',
    [ 0,  2, -1,  0,  0,  2,  0,  2,  0],
    [ 0,  2,  0,  0,  0,  5,  2,  0,  5, -2],
    [-2,  5,  2,  0, -2,  5,  2,  0, 10, -5]
  ],

  // ===== WEIRD =====
  ['Mushroom Spores', 'Weird', 'dark',
    [ 2,  0,  0,  2,  2,  0, -1,  0,  0,  0],
    [ 5, -2,  0,  2,  5,  0,  0,  0,  2,  0],
    [10, -5, -2, 5,  5, -2,  2,  0,  2,  0]
  ],
  ['Skullfish', 'Weird', 'dark',
    [ 0, -1,  2,  0,  0,  2,  2,  0,  0,  0],
    [ 0,  0,  5, -2,  0,  2,  5,  0,  2,  0],
    [ 0,  2, 10, -5, -2,  5,  5, -2,  2,  0]
  ],
  ['Bombfish', 'Weird', 'fire',
    [ 0, -1,  2,  0,  0,  0,  2,  2,  0,  0],
    [ 0,  0,  5,  0,  0,  2,  2,  0,  5, -2],
    [ 0,  2,  5, -2,  0,  2,  5, -2, 10, -5]
  ],
  ['Chu Jelly', 'Weird', 'lightning',
    [ 0,  2,  2,  0,  0, -1,  2,  0,  0,  0],
    [ 0,  5,  2,  0,  0,  0,  5, -2,  2,  0],
    [-2,  5,  5, -2,  0,  2, 10, -5,  2,  0]
  ],
  ['Bee Larvae', 'Weird', 'light',
    [ 0,  0,  2,  0,  0, -1,  2,  0,  2,  0],
    [ 0,  2,  5,  0,  0,  0,  2,  0,  5, -2],
    [ 0,  2,  5, -2,  0,  2,  5, -2,10, -5]
  ],
  ['Rock Sirloin', 'Weird', 'fire',
    [ 0, -1,  2,  0,  0,  0,  2,  2,  0,  0],
    [ 0,  0,  5,  0,  2,  0, -2,  5,  2,  0],
    [ 0,  2,  5, -2,  2,  0, -5,10,  5, -2]
  ]
];

const FOODS = [];
FOOD_BASE.forEach(base => {
  const [name, type, element, b, s, g] = base;
  const rarities = [
    { key: 'bronze', prefixEn: '',        prefixFr: '',         lv: 1, row: b },
    { key: 'silver', prefixEn: 'Tasty ',  prefixFr: 'Savoureux ', lv: 2, row: s },
    { key: 'gold',   prefixEn: 'Delicious ', prefixFr: 'D√©licieux ', lv: 3, row: g }
  ];
  rarities.forEach(r => {
    if (!r.row) return;
    const traits = {};
    ['SPK','RLX','VAL','DIZ','FRN','ASP','RES','SHR','EAG','SMI'].forEach((code, i) => {
      const v = r.row[i];
      if (typeof v === 'number' && v !== 0) traits[code] = v;
    });
    FOODS.push({
      id: `${name.replace(/\s+/g,'-').toLowerCase()}-${r.key}`,
      base: name,
      type,
      element,
      rarity: r.key,
      lvCost: r.lv,
      nameEn: r.prefixEn + name,
      nameFr: (r.key === 'bronze' ? name : r.prefixFr + name),
      traits
    });
  });
});

/* ========== LANGUAGE ========== */
let currentLang = 'en';

const I18N = {
  en: {
    setupTitle: "1. Fairy setup",
    elementLabel: "Element",
    startLevelLabel: "Current level",
    maxLevelLabel: "Level cap before Refresh",
    activeTraitsLabel: "Active personalities (tap, max 5)",
    activeTraitsHint: "Those 5 are the ones shown in white on your fairy.",
    traitsTitle: "2. Current personality values",
    traitsHint: "Enter current values; 0 is fine if unknown.",
    inventoryTitle: "3. Food limits (optional)",
    inventoryHint: "Use if you want to restrict some foods in the plan.",
    showInventory: "Show editable limits for key foods",
    routeTitle: "4. Target 10-skill route",
    routeDesc: "Standard rainbow chain. Each step: reach thresholds ‚Üí unlock ‚Üí Refresh ‚Üí swap.",
    planTitle: "5. Plan",
    planEmpty: "Press Generate to see your cycle-by-cycle food plan.",
    explainSummary: "How this planner thinks",
    explainText:
      "Uses official food values and element bonuses to push traits to each key skill's requirements before your level cap, then suggests one personality swap per Refresh."
  },
  fr: {
    setupTitle: "1. Configuration de la f√©e",
    elementLabel: "√âl√©ment",
    startLevelLabel: "Niveau actuel",
    maxLevelLabel: "Niveau max avant renaissance",
    activeTraitsLabel: "Personnalit√©s actives (5 max)",
    activeTraitsHint: "Les 5 affich√©es en blanc sur ta f√©e.",
    traitsTitle: "2. Valeurs de personnalit√©",
    traitsHint: "Entre les valeurs actuelles ; 0 si tu ne sais pas.",
    inventoryTitle: "3. Limites de nourriture (optionnel)",
    inventoryHint: "√Ä utiliser si tu veux limiter certains aliments.",
    showInventory: "Afficher les limites pour quelques aliments cl√©s",
    routeTitle: "4. Route des 10 comp√©tences",
    routeDesc: "Cha√Æne arc-en-ciel standard. Chaque √©tape : atteindre les seuils ‚Üí d√©bloquer ‚Üí Renaissance ‚Üí changer 1 personnalit√©.",
    planTitle: "5. Plan",
    planEmpty: "Appuie sur G√©n√©rer pour voir le plan d√©taill√©.",
    explainSummary: "Comment fonctionne ce planificateur",
    explainText:
      "Utilise les valeurs officielles des nourritures et le bonus d‚Äô√©l√©ment pour atteindre les pr√©requis de chaque comp√©tence cl√© avant ton niveau max, puis propose un √©change de personnalit√© √† chaque renaissance."
  }
};

function applyLang(lang) {
  currentLang = lang;
  const t = I18N[lang];
  document.getElementById('title').textContent =
    lang === 'fr' ? "Planificateur de f√©e HWDE" : "HWDE Fairy Planner";
  document.getElementById('subtitle').textContent =
    lang === 'fr'
      ? "Plan complet pour obtenir les 10 comp√©tences cl√©s et d√©bloquer toutes les autres."
      : "Plan to reach the 10 key skills that unlock all other fairy skills.";
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    if (t[k]) el.textContent = t[k];
  });
  // Update trait labels
  TRAITS.forEach(tr => {
    const lab = document.getElementById('trait-label-' + tr.code);
    if (lab) lab.innerHTML =
      `${tName(tr.code, lang)} <small>(${tr.code})</small>`;
  });
  renderRouteList();
  renderActiveTraits(true);
  renderInventoryGrid(true);
}

/* ========== UI BUILDERS ========== */

function renderActiveTraits(updateOnly=false) {
  const wrap = document.getElementById('activeTraits');
  if (!updateOnly) wrap.innerHTML = '';
  if (!updateOnly) {
    TRAITS.forEach((tr, idx) => {
      const d = document.createElement('div');
      d.className = 'toggle-pill' + (idx < 5 ? ' active' : '');
      d.dataset.code = tr.code;
      d.innerHTML = `<span></span>${tName(tr.code, currentLang)}`;
      d.onclick = () => {
        // simple: allow toggling; we won't enforce 5 hard, player knows.
        d.classList.toggle('active');
      };
      wrap.appendChild(d);
    });
  } else {
    // update labels
    wrap.querySelectorAll('.toggle-pill').forEach(d => {
      const code = d.dataset.code;
      d.innerHTML = `<span></span>${tName(code, currentLang)}`;
    });
  }
}

function renderTraitsGrid() {
  const g = document.getElementById('traitsGrid');
  g.innerHTML = '';
  TRAITS.forEach(tr => {
    const row = document.createElement('div');
    row.className = 'trait-row';
    row.innerHTML = `
      <div class="trait-label" id="trait-label-${tr.code}">
        ${tName(tr.code, currentLang)} <small>(${tr.code})</small>
      </div>
      <input type="number" id="trait-${tr.code}" min="0" max="999" value="0" />
    `;
    g.appendChild(row);
  });
}

function renderInventoryGrid(updateOnly=false) {
  const g = document.getElementById('inventoryGrid');
  if (updateOnly) {
    // just relabel if needed
    return;
  }
  g.innerHTML = '';
  // Only show a focused subset to keep UI small (key gold/tasty foods).
  FOODS.filter(f => f.rarity !== 'bronze').forEach(f => {
    const row = document.createElement('div');
    row.className = 'trait-row';
    row.innerHTML = `
      <div class="trait-label">${currentLang === 'fr' ? f.nameFr : f.nameEn}
        <small>(${f.rarity})</small></div>
      <input type="number" id="inv-${f.id}" min="0" placeholder="‚àû" />
    `;
    g.appendChild(row);
  });
}

function renderRouteList() {
  const ul = document.getElementById('routeList');
  ul.innerHTML = '';
  ROUTE.forEach((s, i) => {
    const li = document.createElement('li');
    let text = `${i+1}. ${s.name}`;
    if (s.swap) {
      const from = tName(s.swap.from, currentLang);
      const to = tName(s.swap.to, currentLang);
      text += currentLang === 'fr'
        ? ` ‚Üí √† la renaissance : remplacer ${from} par ${to}`
        : ` ‚Üí on Refresh: swap ${from} ‚Üí ${to}`;
    }
    ul.appendChild(li).textContent = text;
  });
}

/* ========== CALC HELPERS ========== */

function elementBonus(base, match) {
  if (!match) return base;
  if (base === 2) return 3;
  if (base === 5) return 6;
  if (base === 10) return 12;
  if (base === -1) return 2;
  if (base === -2) return 1;
  if (base === -5) return -2;
  return base;
}

function foodEffect(food, fairyElement) {
  const match = (food.element === fairyElement);
  const out = {};
  for (const [k,v] of Object.entries(food.traits)) {
    out[k] = elementBonus(v, match);
  }
  return out;
}

function collectState() {
  const fairyElement = document.getElementById('fairyElement').value;
  const startLevel = Math.max(1, Math.min(99,
    parseInt(document.getElementById('startLevel').value || '1')));
  const maxLevel = Math.max(startLevel, Math.min(99,
    parseInt(document.getElementById('maxLevel').value || '99')));

  const traits = {};
  TRAITS.forEach(tr => {
    traits[tr.code] = parseInt(
      document.getElementById('trait-' + tr.code).value || '0'
    ) || 0;
  });

  const allowGold = document.getElementById('optGold').dataset.on === 'true';
  const preferCheap = document.getElementById('optCheap').dataset.on === 'true';

  const inventory = {};
  FOODS.forEach(f => {
    const el = document.getElementById('inv-' + f.id);
    if (el && el.value !== '') {
      inventory[f.id] = parseInt(el.value) || 0;
    }
  });

  return { fairyElement, startLevel, maxLevel, traits, allowGold, preferCheap, inventory };
}

function planStep(state, req, opts) {
  let level = state.level;
  const maxL = state.maxLevel;
  let traits = { ...state.traits };
  const used = {};
  let safety = 0;

  function done() {
    for (const k in req) {
      if ((traits[k] || 0) < req[k]) return false;
    }
    return true;
  }

  while (!done() && level < maxL && safety < 800) {
    safety++;
    let best = null;
    let bestScore = 0;

    for (const f of FOODS) {
      if (!opts.allowGold && f.rarity === 'gold') continue;
      if (opts.inventory[f.id] != null &&
          (used[f.id] || 0) >= opts.inventory[f.id]) continue;
      if (level + f.lvCost > maxL) continue;

      const eff = foodEffect(f, opts.fairyElement);
      let gain = 0;
      let neg = 0;
      for (const k in req) {
        const cur = traits[k] || 0;
        const need = Math.max(0, req[k] - cur);
        const d = eff[k] || 0;
        if (d > 0 && need > 0) gain += Math.min(d, need);
        if (d < 0 && need > 0) neg += -d;
      }
      if (gain <= 0) continue;

      let score = gain - neg * 0.5;
      if (opts.preferCheap) {
        score = score / f.lvCost + (f.rarity === 'bronze' ? 0.2 : f.rarity === 'silver' ? 0.05 : 0);
      } else {
        score = score / f.lvCost;
      }

      if (score > bestScore) {
        bestScore = score;
        best = { f, eff };
      }
    }

    if (!best) break;

    used[best.f.id] = (used[best.f.id] || 0) + 1;
    level += best.f.lvCost;
    for (const k in best.eff) {
      traits[k] = Math.max(0, (traits[k] || 0) + best.eff[k]);
    }
  }

  const ok = done();
  const foodLines = Object.keys(used).map(id => {
    const f = FOODS.find(x => x.id === id);
    const n = used[id];
    const name = currentLang === 'fr' ? f.nameFr : f.nameEn;
    return { text: `${n}√ó ${name} (${f.rarity})`, rarity: f.rarity };
  }).sort((a,b) => a.text.localeCompare(b.text));

  return { ok, foods: foodLines, endLevel: level, endTraits: traits };
}

function applyRefresh(prevTraits, swap) {
  const next = {};
  for (const t of TRAITS) {
    const v = prevTraits[t.code] || 0;
    next[t.code] = Math.floor(v * 0.6); // simplified carry-over
  }
  if (swap && swap.from && swap.to) {
    const fromVal = next[swap.from] || 0;
    if ((next[swap.to] || 0) < fromVal) {
      next[swap.to] = fromVal;
    }
  }
  return next;
}

/* ========== GENERATE PLAN ========== */

function generatePlan() {
  const planEl = document.getElementById('plan');
  planEl.innerHTML = '';
  const s = collectState();

  let traits = { ...s.traits };
  let level = s.startLevel;

  ROUTE.forEach((step, idx) => {
    const card = document.createElement('div');
    card.className = 'step';

    const title = document.createElement('div');
    title.className = 'step-title';
    title.textContent = `${idx+1}. ${step.name}`;
    card.appendChild(title);

    const req = SKILLS[step.name];
    const sub = document.createElement('div');
    sub.className = 'step-sub';
    sub.textContent =
      (currentLang === 'fr' ? 'Seuils : ' : 'Targets: ') +
      Object.keys(req).map(k => `${tName(k, currentLang)} ‚â• ${req[k]}`).join(', ');
    card.appendChild(sub);

    const stepPlan = planStep(
      { level, maxLevel: s.maxLevel, traits },
      req,
      {
        allowGold: s.allowGold,
        preferCheap: s.preferCheap,
        inventory: s.inventory,
        fairyElement: s.fairyElement
      }
    );

    if (stepPlan.foods.length) {
      const ul = document.createElement('ul');
      ul.className = 'food-list';
      stepPlan.foods.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.text;
        ul.appendChild(li);
      });
      card.appendChild(ul);
    } else {
      const w = document.createElement('div');
      w.className = 'warn';
      w.textContent = currentLang === 'fr'
        ? "Aucune combinaison simple trouv√©e avec ces limites / ce niveau. Autorise plus de nourritures ou monte le niveau max."
        : "No simple combination found with current limits/level. Try allowing more foods or a higher level cap.";
      card.appendChild(w);
    }

    if (!stepPlan.ok) {
      const w = document.createElement('div');
      w.className = 'warn';
      w.textContent = currentLang === 'fr'
        ? "Attention : certains seuils ne sont pas atteints avant le niveau max configur√©."
        : "Warning: some thresholds could not be met before your configured level cap.";
      card.appendChild(w);
    }

    // Prepare next cycle
    if (idx < ROUTE.length - 1) {
      const after = applyRefresh(stepPlan.endTraits, step.swap);
      const sText = step.swap
        ? (currentLang === 'fr'
            ? `Apr√®s avoir obtenu ${step.name}, fais rena√Ætre ta f√©e (retour niv.1) et remplace ${tName(step.swap.from,currentLang)} par ${tName(step.swap.to,currentLang)}.`
            : `After unlocking ${step.name}, Refresh (back to Lv1) and swap ${tName(step.swap.from,currentLang)} ‚Üí ${tName(step.swap.to,currentLang)}.`)
        : (currentLang === 'fr'
            ? "Apr√®s cette √©tape, continue √† optimiser selon tes besoins."
            : "After this step, continue optimizing as you like.");
      const p = document.createElement('div');
      p.className = 'step-sub';
      p.textContent = sText;
      card.appendChild(p);
      traits = after;
      level = 1;
    }

    planEl.appendChild(card);
  });
}

/* ========== INIT & EVENTS ========== */

document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    applyLang(btn.dataset.lang);
  });
});

['optGold','optCheap'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('click', () => {
    const on = el.dataset.on === 'true';
    el.dataset.on = on ? 'false' : 'true';
    el.classList.toggle('active', !on);
  });
});

document.getElementById('generateBtn').addEventListener('click', generatePlan);

// Build initial UI
renderActiveTraits(false);
renderTraitsGrid();
renderInventoryGrid(false);
renderRouteList();
applyLang('en');
</script>
</body>
</html>
